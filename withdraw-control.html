<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Withdraw Admin Panel</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
body {
    font-family: Arial;
    background: #0d0d0d;
    color: white;
    padding: 15px;
}

h2 {
    text-align: center;
}

.box {
    background: #1a1a1a;
    padding: 15px;
    margin: 12px 0;
    border-radius: 10px;
    border-left: 5px solid orange;
}

.btn {
    padding: 7px 12px;
    border: none;
    border-radius: 5px;
    color: white;
    cursor: pointer;
    margin-right: 8px;
}

.approve { background: green; }
.reject { background: red; }
.pending { color: orange; }
.approved { color: #00ff00; }
.rejected { color: #ff3333; }

.small {
    font-size: 13px;
    opacity: 0.8;
}
</style>
</head>
<body>

<h2>Withdraw Requests (Admin)</h2>

<div id="withdrawList"></div>

<script>
// ---------------- Firebase Config ----------------
const firebaseConfig = {
    apiKey: "AIzaSyBl0PIm4lvZea96Bte3KaKQJvurGE1P8Es",
    authDomain: "post-c7e41.firebaseapp.com",
    databaseURL: "https://post-c7e41-default-rtdb.firebaseio.com",
    projectId: "post-c7e41",
    storageBucket: "post-c7e41.appspot.com",
    messagingSenderId: "758133068153",
    appId: "1:758133068153:web:28ef27e45d8037e0d49fa8"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------------- Load All Withdraw Requests ----------------
db.ref("withdrawRequests").on("value", snapshot => {
    let listBox = document.getElementById("withdrawList");
    listBox.innerHTML = "";

    snapshot.forEach(userReq => {
        let uid = userReq.key;

        userReq.forEach(req => {
            let data = req.val();

            listBox.innerHTML += `
                <div class="box">
                    <p><b>User:</b> ${uid}</p>
                    <p><b>Amount:</b> ${data.amount} BDT</p>
                    <p><b>Method:</b> ${data.method}</p>
                    <p><b>Number:</b> ${data.number}</p>
                    <p><b>Date:</b> <span class="small">${data.date}</span></p>
                    <p>Status: 
                        <span class="${data.status}">
                            ${data.status.toUpperCase()}
                        </span>
                    </p>

                    ${data.status === "pending" ? `
                        <button class="btn approve" onclick="approve('${uid}','${req.key}', ${data.amount})">Approve</button>
                        <button class="btn reject" onclick="reject('${uid}','${req.key}')">Reject</button>
                    ` : ``}
                </div>
            `;
        });
    });
});

// ---------------- Approve Withdraw ----------------
function approve(uid, reqId, amount) {

    // Update Request Status
    db.ref("withdrawRequests/" + uid + "/" + reqId).update({
        status: "approved"
    });

    // Reduce User Balance
    db.ref("users/" + uid + "/balance").once("value", snap => {
        let balance = snap.val() ?? 0;
        let newBalance = balance - amount;

        if (newBalance < 0) newBalance = 0;

        db.ref("users/" + uid + "/balance").set(newBalance);
    });

    alert("Withdrawal Approved!");
}

// ---------------- Reject Withdraw ----------------
function reject(uid, reqId) {

    db.ref("withdrawRequests/" + uid + "/" + reqId).update({
        status: "rejected"
    });

    alert("Withdrawal Rejected!");
}
</script>

</body>
</html>